#####################################################################
# 	Macros
#####################################################################

# Safe Home
[gcode_macro SG28]
gcode:
    {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes or "z" not in printer.toolhead.homed_axes %}
    G28
    {% endif %}

[gcode_macro G32]
gcode:
    # BED_MESH_CLEAR
    SG28
    Z_TILT_ADJUST
    SG28
    G0 X125 Y125 Z30 F3600

[gcode_macro PRINT_START]
gcode:
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(190)|float %}
	# Clear Display
	M117
	# Clear Existing Feedrate
	# M220 S100
	# Clear Existing Flowrate
	# M221 S100
    G32
    # Heat bed
    M117 Bed: {BED_TEMP}c
    M140 S{BED_TEMP}
    # safe home
    # M117 Hotend: 150c
    # M109 S150
    # Wait for Bed
    # M117 Wait Bed: {BED_TEMP}c
    M190 S{BED_TEMP}
    M117 Bed heated: {BED_TEMP}c


    # M117 Starting Bed Mesh
    # BED_MESH_CALIBRATE ADAPTIVE=1
    
    M104 s0 # Fan off, why?
	# Move to side and wait for final temps
    G1 X1 Y10 Z5 F3000
    M117 Wait Hotend: {EXTRUDER_TEMP}c
    M109 S{EXTRUDER_TEMP}
    
    G91
    G1 E25 F3600
    
	# Relative Extruder
	M83
	# Set units to millimeters
	G21 
	# Use absolute coordinates
	G90
	# Use absolute distances for extrusion
	M82
	# Fan Off
	M107
    
	NOZZLE_PURGE   


# [gcode_macro PRINT_START]
# gcode:
#   # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
#   {% set target_bed = params.BED|int %}
#   {% set target_extruder = params.EXTRUDER|int %}
#   # {% set target_chamber = params.CHAMBER|default("45")|int %}
#   {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
#   {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

#   # Home the printer, set absolute positioning and update the Stealthburner LEDs.
#   STATUS_HOMING                                         # Set LEDs to homing-mode
#   SG28                                                  # Full home (XYZ)
#   G90                                                   # Absolute position
#   BED_MESH_CLEAR                                        # Clear old saved bed mesh (if any)

#   # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
#   {% if params.BED|int > 90 %}
#     SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
#     STATUS_HEATING                                      # Set LEDs to heating-mode
#     M106 S255                                           # Turn on the PT-fan

#     ##  Uncomment if you have a Nevermore.
#     #SET_PIN PIN=nevermore VALUE=1                      # Turn on the nevermore

#     G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
#     M190 S{target_bed}                                  # Set the target temp for the bed
#     # G4 P300000                                          # Wait 5 min for the bedtemp to stabilize
#     # SET_DISPLAY_TEXT MSG="Heatsoak: {target_chamber}c"  # Display info on display
#     # TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}   # Waits for chamber temp

#   # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 5 min soak
#   {% else %}
#     SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
#     STATUS_HEATING                                      # Set LEDs to heating-mode
#     G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
#     M190 S{target_bed}                                  # Set the target temp for the bed
#     SET_DISPLAY_TEXT MSG="Soak for 5 min"               # Display info on display
#     # G4 P300000                                          # Wait 5 min for the bedtemp to stabilize
#   {% endif %}

#   # Heat hotend to 150c. This helps with getting a correct Z-home.
#   SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
#   M109 S150                                             # Heat hotend to 150c

#   ##  Uncomment for Trident (Z_TILT_ADJUST)
#   SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
#   STATUS_LEVELING                                      # Set LEDs to leveling-mode
#   Z_TILT_ADJUST                                        # Level the printer via Z_TILT_ADJUST
#   G28 Z                                                # Home Z again after Z_TILT_ADJUST

#   ##  Uncomment for bed mesh (2 of 2 for bed mesh)
#   SET_DISPLAY_TEXT MSG="Bed mesh"                      # Display info on display
#   STATUS_MESHING                                       # Set LEDs to bed mesh-mode
#   BED_MESH_CALIBRATE                                   # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh

#   # Heat up the hotend up to target via data from slicer
#   SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"     # Display info on display
#   STATUS_HEATING                                        # Set LEDs to heating-mode
#   G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
#   M107                                                  # Turn off partcooling fan
#   M109 S{target_extruder}                               # Heat the hotend to set temp

#   # Get ready to print by doing a primeline and updating the LEDs
#   SET_DISPLAY_TEXT MSG="Printing"                       # Display info on display
#   STATUS_PRINTING                                       # Set LEDs to printing-mode
#   G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
#   G0 Z0.4                                               # Raise Z to 0.4
#   G91                                                   # Incremental positioning 
#   G1 X100 E20 F1000                                     # Primeline
#   G90                                                   # Absolute position


[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X125 Y250 F3600            ; park nozzle at rear
    # BED_MESH_CLEAR
    
    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0


[gcode_macro NOZZLE_PURGE]
description: Draw a purge line at the front left edge of the build plate
gcode:
  SG28
  G0 X2.5 Y2 F6000 ; Go to front
  G0 Z0.2 ; Drop to bed
  M83 ; Set extruder to relative mode
  G1 X25 E10 F500 ; Extrude 25mm of filament in a 4cm line
  G1 X50 F5000 ; Quickly wipe away from the filament line
  G1 X75 E2.00 F1500
  G1 E-0.1 F400 ; Retract a little
  G1 Z0.5 ; Raise and begin printing.
